<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Video Synopsis Viewer</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #242834;
    --border: #2e3347;
    --text: #e4e6ef;
    --text-dim: #8b8fa3;
    --accent: #6c5ce7;
    --accent-glow: rgba(108, 92, 231, 0.25);
    --synopsis: #00cec9;
    --synopsis-glow: rgba(0, 206, 201, 0.25);
    --original: #fdcb6e;
    --original-glow: rgba(253, 203, 110, 0.25);
    --danger: #ff6b6b;
    --radius: 12px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Inter', -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  .header {
    padding: 24px 40px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: linear-gradient(180deg, var(--surface) 0%, var(--bg) 100%);
  }

  .header h1 {
    font-size: 20px;
    font-weight: 600;
    letter-spacing: -0.3px;
  }

  .header h1 span {
    color: var(--accent);
  }

  .stats-bar {
    display: flex;
    gap: 24px;
    font-size: 13px;
    color: var(--text-dim);
  }

  .stat-value {
    color: var(--text);
    font-weight: 600;
    margin-left: 4px;
  }

  /* ‚îÄ‚îÄ Load Section ‚îÄ‚îÄ */
  .load-section {
    max-width: 700px;
    margin: 80px auto;
    text-align: center;
    padding: 0 20px;
  }

  .load-section h2 {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 8px;
    letter-spacing: -0.5px;
  }

  .load-section p {
    color: var(--text-dim);
    margin-bottom: 32px;
    font-size: 15px;
  }

  .drop-zone {
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    padding: 48px;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--surface);
  }

  .drop-zone:hover, .drop-zone.dragover {
    border-color: var(--accent);
    background: rgba(108, 92, 231, 0.05);
    box-shadow: 0 0 30px var(--accent-glow);
  }

  .drop-zone .icon {
    font-size: 40px;
    margin-bottom: 12px;
  }

  .drop-zone .label {
    font-size: 15px;
    font-weight: 500;
  }

  .drop-zone .sublabel {
    font-size: 13px;
    color: var(--text-dim);
    margin-top: 4px;
  }

  .file-inputs {
    margin-top: 24px;
    display: flex;
    gap: 12px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .file-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text);
    transition: all 0.15s;
  }

  .file-btn:hover {
    border-color: var(--accent);
    background: var(--surface2);
  }

  .file-btn.loaded {
    border-color: #00b894;
    color: #00b894;
  }

  input[type="file"] { display: none; }

  /* ‚îÄ‚îÄ Main Content ‚îÄ‚îÄ */
  .main-content {
    display: none;
    padding: 24px 40px 60px;
  }

  .main-content.visible {
    display: block;
  }

  /* ‚îÄ‚îÄ Video Players ‚îÄ‚îÄ */
  .video-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 32px;
  }

  .video-card {
    background: var(--surface);
    border-radius: var(--radius);
    overflow: hidden;
    border: 1px solid var(--border);
  }

  .video-card-header {
    padding: 12px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--border);
  }

  .video-card-header .tag {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    padding: 4px 10px;
    border-radius: 6px;
  }

  .tag-original {
    background: var(--original-glow);
    color: var(--original);
  }

  .tag-synopsis {
    background: var(--synopsis-glow);
    color: var(--synopsis);
  }

  .video-card-header .time {
    font-size: 13px;
    font-family: 'SF Mono', 'Fira Code', monospace;
    color: var(--text-dim);
  }

  .video-card video {
    width: 100%;
    display: block;
    background: #000;
  }

  /* ‚îÄ‚îÄ Table ‚îÄ‚îÄ */
  .table-section {
    background: var(--surface);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    overflow: hidden;
  }

  .table-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .table-header h3 {
    font-size: 14px;
    font-weight: 600;
  }

  .table-header .hint {
    font-size: 12px;
    color: var(--text-dim);
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  thead th {
    padding: 10px 16px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--text-dim);
    background: var(--surface2);
    text-align: left;
    border-bottom: 1px solid var(--border);
  }

  tbody tr {
    transition: background 0.15s;
    cursor: pointer;
    border-bottom: 1px solid var(--border);
  }

  tbody tr:last-child {
    border-bottom: none;
  }

  tbody tr:hover {
    background: rgba(108, 92, 231, 0.06);
  }

  tbody tr.active {
    background: rgba(108, 92, 231, 0.12);
  }

  tbody td {
    padding: 10px 16px;
    font-size: 13px;
  }

  .track-id {
    font-family: 'SF Mono', 'Fira Code', monospace;
    font-size: 12px;
    color: var(--accent);
    font-weight: 500;
  }

  .class-badge {
    display: inline-block;
    padding: 2px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    background: var(--surface2);
    border: 1px solid var(--border);
  }

  .time-cell {
    font-family: 'SF Mono', 'Fira Code', monospace;
    font-size: 12px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 6px;
    transition: all 0.15s;
  }

  .time-cell.original:hover {
    background: var(--original-glow);
    color: var(--original);
  }

  .time-cell.synopsis:hover {
    background: var(--synopsis-glow);
    color: var(--synopsis);
  }

  .time-cell .arrow {
    color: var(--text-dim);
    margin: 0 3px;
  }

  .duration-cell {
    font-family: 'SF Mono', 'Fira Code', monospace;
    font-size: 12px;
    color: var(--text-dim);
  }

  /* ‚îÄ‚îÄ Timeline bar in table ‚îÄ‚îÄ */
  .timeline-bar-cell {
    width: 200px;
    padding: 10px 16px;
  }

  .timeline-bar-bg {
    width: 100%;
    height: 6px;
    background: var(--surface2);
    border-radius: 3px;
    position: relative;
    overflow: hidden;
  }

  .timeline-bar-fill {
    position: absolute;
    height: 100%;
    border-radius: 3px;
    background: linear-gradient(90deg, var(--accent), var(--synopsis));
    opacity: 0.8;
    transition: opacity 0.15s;
  }

  tr:hover .timeline-bar-fill {
    opacity: 1;
  }

  /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
  @media (max-width: 900px) {
    .video-grid { grid-template-columns: 1fr; }
    .header { padding: 16px 20px; flex-direction: column; gap: 12px; }
    .main-content { padding: 16px 20px 40px; }
    .stats-bar { flex-wrap: wrap; gap: 12px; }
  }
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ Load Screen ‚îÄ‚îÄ -->
<div class="load-section" id="loadSection">
  <h2>Synopsis Viewer</h2>
  <p>Load your synopsis data and videos to explore the timeline interactively.</p>

  <div class="drop-zone" id="dropZone">
    <div class="icon">üìÇ</div>
    <div class="label">Drop JSON summary file here</div>
    <div class="sublabel">or click to browse ‚Äî the <code>.mp4.json</code> file generated by the pipeline</div>
  </div>
  <input type="file" id="jsonInput" accept=".json">

  <div class="file-inputs">
    <label class="file-btn" id="origBtn">
      üé¨ Load Original Video
      <input type="file" id="origVideo" accept="video/*">
    </label>
    <label class="file-btn" id="synBtn">
      üéûÔ∏è Load Synopsis Video
      <input type="file" id="synVideo" accept="video/*">
    </label>
  </div>
</div>

<!-- ‚îÄ‚îÄ Header ‚îÄ‚îÄ -->
<div class="header" id="appHeader" style="display:none;">
  <h1>Synopsis <span>Viewer</span></h1>
  <div class="stats-bar" id="statsBar"></div>
</div>

<!-- ‚îÄ‚îÄ Main Content ‚îÄ‚îÄ -->
<div class="main-content" id="mainContent">
  <div class="video-grid">
    <div class="video-card">
      <div class="video-card-header">
        <span class="tag tag-original">Original</span>
        <span class="time" id="origTime">0:00.0</span>
      </div>
      <video id="videoOriginal" controls preload="metadata"></video>
    </div>
    <div class="video-card">
      <div class="video-card-header">
        <span class="tag tag-synopsis">Synopsis</span>
        <span class="time" id="synTime">0:00.0</span>
      </div>
      <video id="videoSynopsis" controls preload="metadata"></video>
    </div>
  </div>

  <div class="table-section">
    <div class="table-header">
      <h3>Activity Timeline</h3>
      <span class="hint">Click timestamps to seek video</span>
    </div>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Track</th>
          <th>Class</th>
          <th>Original</th>
          <th>Synopsis</th>
          <th>Duration</th>
          <th>Timeline</th>
        </tr>
      </thead>
      <tbody id="tubeTable"></tbody>
    </table>
  </div>
</div>

<script>
// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let summaryData = null;

// ‚îÄ‚îÄ Elements ‚îÄ‚îÄ
const dropZone     = document.getElementById('dropZone');
const jsonInput    = document.getElementById('jsonInput');
const origVideoIn  = document.getElementById('origVideo');
const synVideoIn   = document.getElementById('synVideo');
const origBtn      = document.getElementById('origBtn');
const synBtn       = document.getElementById('synBtn');
const loadSection  = document.getElementById('loadSection');
const appHeader    = document.getElementById('appHeader');
const mainContent  = document.getElementById('mainContent');
const statsBar     = document.getElementById('statsBar');
const tubeTable    = document.getElementById('tubeTable');
const videoOrig    = document.getElementById('videoOriginal');
const videoSyn     = document.getElementById('videoSynopsis');
const origTimeEl   = document.getElementById('origTime');
const synTimeEl    = document.getElementById('synTime');

// ‚îÄ‚îÄ File Loading ‚îÄ‚îÄ
dropZone.addEventListener('click', () => jsonInput.click());
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('dragover');
  if (e.dataTransfer.files.length) loadJSON(e.dataTransfer.files[0]);
});
jsonInput.addEventListener('change', e => { if (e.target.files.length) loadJSON(e.target.files[0]); });

origVideoIn.addEventListener('change', e => {
  if (e.target.files.length) {
    videoOrig.src = URL.createObjectURL(e.target.files[0]);
    origBtn.classList.add('loaded');
    origBtn.querySelector('input').previousSibling.textContent = '‚úì Original loaded ';
    tryShow();
  }
});

synVideoIn.addEventListener('change', e => {
  if (e.target.files.length) {
    videoSyn.src = URL.createObjectURL(e.target.files[0]);
    synBtn.classList.add('loaded');
    synBtn.querySelector('input').previousSibling.textContent = '‚úì Synopsis loaded ';
    tryShow();
  }
});

function loadJSON(file) {
  const reader = new FileReader();
  reader.onload = e => {
    try {
      summaryData = JSON.parse(e.target.result);
      dropZone.innerHTML = `
        <div class="icon">‚úÖ</div>
        <div class="label">${file.name}</div>
        <div class="sublabel">${summaryData.total_tubes} tubes loaded</div>
      `;
      tryShow();
    } catch (err) {
      alert('Invalid JSON file: ' + err.message);
    }
  };
  reader.readAsText(file);
}

function tryShow() {
  if (!summaryData) return;
  // Show the main UI even with just the JSON ‚Äî videos are optional
  loadSection.style.display = 'none';
  appHeader.style.display = 'flex';
  mainContent.classList.add('visible');
  renderStats();
  renderTable();
}

// ‚îÄ‚îÄ Render Stats ‚îÄ‚îÄ
function renderStats() {
  const d = summaryData;
  statsBar.innerHTML = `
    <span>Original<span class="stat-value">${d.original_duration}s</span></span>
    <span>Synopsis<span class="stat-value">${d.synopsis_duration}s</span></span>
    <span>Ratio<span class="stat-value">${(d.compression_ratio * 100).toFixed(1)}%</span></span>
    <span>Objects<span class="stat-value">${d.total_tubes}</span></span>
    <span>FPS<span class="stat-value">${d.fps}</span></span>
  `;
}

// ‚îÄ‚îÄ Render Table ‚îÄ‚îÄ
function renderTable() {
  const tubes = summaryData.tubes;
  const maxEnd = summaryData.synopsis_duration;

  tubeTable.innerHTML = tubes.map((t, i) => {
    const barLeft  = (t.synopsis_from / maxEnd * 100).toFixed(1);
    const barWidth = ((t.synopsis_to - t.synopsis_from) / maxEnd * 100).toFixed(1);
    const durSec   = (t.duration_frames / summaryData.fps).toFixed(1);

    return `
      <tr data-idx="${i}">
        <td>${i + 1}</td>
        <td><span class="track-id">#${t.track_id}</span></td>
        <td><span class="class-badge">${t.class_name}</span></td>
        <td>
          <span class="time-cell original" data-seek-orig="${t.original_from}">
            ${t.original_from}s<span class="arrow">‚Üí</span>${t.original_to}s
          </span>
        </td>
        <td>
          <span class="time-cell synopsis" data-seek-syn="${t.synopsis_from}">
            ${t.synopsis_from}s<span class="arrow">‚Üí</span>${t.synopsis_to}s
          </span>
        </td>
        <td><span class="duration-cell">${durSec}s (${t.duration_frames}f)</span></td>
        <td class="timeline-bar-cell">
          <div class="timeline-bar-bg">
            <div class="timeline-bar-fill" style="left:${barLeft}%; width:${barWidth}%"></div>
          </div>
        </td>
      </tr>
    `;
  }).join('');

  // Click handlers
  tubeTable.querySelectorAll('.time-cell.original').forEach(el => {
    el.addEventListener('click', e => {
      e.stopPropagation();
      const time = parseFloat(el.dataset.seekOrig);
      seekVideo(videoOrig, time);
      highlightRow(el.closest('tr'));
    });
  });

  tubeTable.querySelectorAll('.time-cell.synopsis').forEach(el => {
    el.addEventListener('click', e => {
      e.stopPropagation();
      const time = parseFloat(el.dataset.seekSyn);
      seekVideo(videoSyn, time);
      highlightRow(el.closest('tr'));
    });
  });

  // Row click seeks both
  tubeTable.querySelectorAll('tr').forEach(tr => {
    tr.addEventListener('click', () => {
      const idx = parseInt(tr.dataset.idx);
      const t = summaryData.tubes[idx];
      seekVideo(videoOrig, t.original_from);
      seekVideo(videoSyn, t.synopsis_from);
      highlightRow(tr);
    });
  });
}

function seekVideo(video, time) {
  if (video.src) {
    video.currentTime = time;
    video.play();
  }
}

function highlightRow(tr) {
  tubeTable.querySelectorAll('tr.active').forEach(r => r.classList.remove('active'));
  tr.classList.add('active');
}

// ‚îÄ‚îÄ Live time display ‚îÄ‚îÄ
function formatTime(sec) {
  const m = Math.floor(sec / 60);
  const s = (sec % 60).toFixed(1);
  return `${m}:${s.padStart(4, '0')}`;
}

videoOrig.addEventListener('timeupdate', () => {
  origTimeEl.textContent = formatTime(videoOrig.currentTime);
});

videoSyn.addEventListener('timeupdate', () => {
  synTimeEl.textContent = formatTime(videoSyn.currentTime);
  // Auto-highlight rows matching current synopsis time
  if (summaryData) {
    const ct = videoSyn.currentTime;
    tubeTable.querySelectorAll('tr').forEach(tr => {
      const idx = parseInt(tr.dataset.idx);
      const t = summaryData.tubes[idx];
      if (ct >= t.synopsis_from && ct <= t.synopsis_to) {
        tr.classList.add('active');
      } else {
        tr.classList.remove('active');
      }
    });
  }
});
</script>
</body>
</html>
